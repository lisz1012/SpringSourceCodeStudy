# 高并发

## 前言

不要因为技术而技术，要明白为什么要有这个技术，技术的原理，因该怎么用这个技术  
拿着天使投资花在营销上，会赚的更多。很多人就在做营销，手段极其残忍。比如陌陌这个app，有正规渠道可以获知它：  
1. CCTV广告，陌陌让具有相同爱好的人聚在一起（其实就是解决一个晚上的问题，也可以让兴趣相同的人聚在一起）  
2. 百度买关键字排名  
3. 找微博大V给钱推广  
4. 制造话题营销   
已经从单纯关注流量转向了关注VIP用户和赚会员费  
更多的人下载使用服务，这就带来了高并发的问题  
渠道流量有时候容易被忽略：就是用户从哪个网站的链接上访问的我的网站。日志分析可以得到这个数据，再配合后台交易记录做Join，就可以分析出每个渠道的转化率或者购买力。然后下一轮融资再投广告的时候，  
就往转化率高的渠道投资。JD除了自己卖东西也可以做3P，提供平台服务第三方商家，这时候东哥就可以拿着这个数据给商家，说你为什么转化率少呢？我可以提供服务帮你提高转化率  

中国移动互联网用户7亿，固定端上网用户5亿，一共12亿用户总量（有重复计算），假设20%的人看到了我们的推广，又有20%下载，又有20%付费，这就是1000万用户了，在假设20%的常年高活跃度用户，那就是200万日活，
做到这个已经很不容易了。所以企业要想做的好，必须处理上万甚至百万级并发。下面引出技术

## 技术部分

高并发的技术主要有两大类：4层技术和7层技术（OSI参考模型）  
应用层：用户接口，比如浏览器tomcat。其中的协议有http，https，smtp，ssh.例子：```cd /proc/$$/fd```  $$是当前进程（当前cmd shell）fd是文件描述符。```ll```会出现0，1，2，分别表示输入输出和报错  
       ```exec 8<> /dev/tcp/www.baidu.com/80```此时再次执行```ll```发现出现了一个编号为8的socket。这一点可见linux系统真的是“一切皆文件”，看似一个文件/dev/tcp/www.baidu.com/80 ，其实在
       内核之中会转化成一个套接字，也就是说已经和baidu建立了一次握手创建出了一个通信了。这时执行```echo -e 'GET / HTTP/1.0\n' >& 8``` '&'表示后面跟的不是文件而是文件描述符8，-e选项会识别\n变成
       换行符。```'GET / HTTP/1.0\n'```就是http协议里面规定的request请求头最小的写法。echo完了之后重定向给socket，也就是发送给百度，然后百度会返回response到8这个文件描述符。此时执行
       ```cat 0<& 8```就可以看到返回的页面文本。但是整个过程要快，可以先关掉8这个文件描述符再重新来：```exec 8<& -```第一步建立连接，第二步才是传送数据，传送数据的时候用http协议规范，以上就是应用
       层协议：符合规范的字符串。手写GET / HTTP/1.0就是模拟浏览器。而浏览器只是把数据内容写规整了，而不是直接发走数据，他只是调下面的层次去了，他调用传输控制层，告诉他想和百度传输数据，你先帮我建立连
       接（socket），我在把数据传输过去，然后百度传回来数据，浏览器再进行渲染变成图形。应用层是用户态，而下面的都在内核态。建立连接会调用底层native代码  
表示层：协议语意，段落划分，字符串的表示，加密  
会话层：session控制
传输控制层：如何让传输确认成功或者失败（TCP/UDP）跟具体的应用程序无关，所有应用程序都会来调用。  
1. TCP，面向连接的可靠的协议。发过去就发回来确认。三次握手和四次分手+确认机制，三次握手：先看对面女生一眼，女生回看一眼，说明她也有意思，此时如果我不再看女生了，那说明没看上，无法建立连接，如果我再次回看她，
	那好，确认过眼神，连接建立！最后一次握手不可少，得让人家姑娘明白我对人家也有意思，踏实了！三次握手成功的话，双方都能确定自己的输入和输出都没问题。三次握手之后才会开辟线程，对象，描述符等相应的资源。也就
	是说三次握手会使资源带来消耗    
2. UPD，非面向连接的不可靠的  

网络层：设备中如何去路由，如何找到节点，如何通信，数据包怎么发  
链路层：点点之间用什么协议，写出一个什么样的东西能发到对方那里去（PPPoE）  
物理层：wifi，4G，5G，光纤等设施很多，每种设施的协议还不一样  

5层协议中，会话层和表示层就被并入了应用层  

软件工程学的精髓是分层解耦，只要对上面的接口不变，下面的实现可以做任何改进